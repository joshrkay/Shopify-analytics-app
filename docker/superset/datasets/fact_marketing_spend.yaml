# Superset Dataset: Fact Marketing Spend (Canonical v1)
# Source: analytics/models/canonical/fact_marketing_spend_v1.sql
#
# Column allow-list: ONLY columns listed below are exposed in Superset.
# Internal columns (source_system, source_primary_key) are excluded.
#
# IMPORTANT:
# - No derived business metrics (CPM, CPC, ROAS) — those live in the metrics layer
# - RLS enforced via tenant_id
# - Grain: one row per tenant + source_system + campaign + ad_set + date

dataset:
  table_name: fact_marketing_spend
  schema: analytics
  description: |
    Canonical marketing spend fact table (v1). Multi-platform ad spend data.
    Sources: Meta (Facebook), Google Ads, TikTok, Snapchat.
    Business metrics (CPM, CPC, CTR, ROAS) are NOT in this table —
    they belong in the semantic/metrics layer.

  dbt_model: fact_marketing_spend_v1
  metric_version: v1
  version_status: active

  columns:
    - column_name: id
      type: VARCHAR
      description: Surrogate key
      filterable: false
      groupby: false

    - column_name: tenant_id
      type: VARCHAR
      description: Tenant identifier (RLS enforced)
      filterable: false
      groupby: false
      is_rls_column: true

    - column_name: spend_date
      type: TIMESTAMP
      description: Business date for the spend record
      filterable: true
      groupby: true
      is_dttm: true

    - column_name: channel
      type: VARCHAR
      description: Canonical marketing channel (facebook, google, tiktok, snapchat)
      filterable: true
      groupby: true

    - column_name: campaign_id
      type: VARCHAR
      description: Campaign identifier from the ad platform
      filterable: true
      groupby: true

    - column_name: ad_set_id
      type: VARCHAR
      description: Ad set / ad group identifier (nullable)
      filterable: true
      groupby: true

    - column_name: spend
      type: NUMERIC
      description: Ad spend amount in currency
      filterable: false
      groupby: false

    - column_name: impressions
      type: INTEGER
      description: Number of ad impressions
      filterable: false
      groupby: false

    - column_name: clicks
      type: INTEGER
      description: Number of ad clicks
      filterable: false
      groupby: false

    - column_name: currency
      type: VARCHAR
      description: Currency code
      filterable: true
      groupby: true

  # Columns explicitly EXCLUDED (internal):
  # - source_system: internal lineage
  # - source_primary_key: internal lineage
  # - updated_at: internal timestamp
  # - dbt_updated_at: internal timestamp

  metrics:
    - metric_name: total_spend
      expression: SUM(spend)
      description: Total ad spend

    - metric_name: avg_daily_spend
      expression: AVG(spend)
      description: Average daily spend

    - metric_name: total_impressions
      expression: SUM(impressions)
      description: Total impressions

    - metric_name: total_clicks
      expression: SUM(clicks)
      description: Total clicks

  rls:
    enabled: true
    clause: "tenant_id = '{{ current_user.tenant_id }}'"

  guardrails:
    max_date_range_days: 90
    query_timeout_seconds: 20
    row_limit: 50000
    cache_ttl_minutes: 30

  visualizations_allowed:
    - line
    - bar
    - pie
    - table
    - number
    - area

  visualizations_disallowed:
    - scatter
    - geo_map
    - box_plot
