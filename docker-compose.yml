# Docker Compose for Local Development
# Run with: docker-compose up -d
#
# This starts:
# - PostgreSQL database
# - Redis cache
# - Backend API (FastAPI)
# - Frontend (React/Vite) - optional, can run separately with npm run dev

version: '3.8'

services:
  # =============================================================================
  # PostgreSQL Database
  # =============================================================================
  postgres:
    image: postgres:15
    container_name: markinsight-db
    environment:
      POSTGRES_USER: markinsight_user
      POSTGRES_PASSWORD: localdev123
      POSTGRES_DB: markinsight
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U markinsight_user -d markinsight"]
      interval: 5s
      timeout: 5s
      retries: 5

  # =============================================================================
  # Redis Cache
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: markinsight-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # =============================================================================
  # Apache Superset (Embedded Analytics)
  # =============================================================================
  superset:
    build:
      context: .
      dockerfile: docker/superset.Dockerfile
    container_name: markinsight-superset
    ports:
      - "8088:8088"
    environment:
      - SUPERSET_SECRET_KEY=${SUPERSET_SECRET_KEY:-superset-secret-key-for-local-dev-only}
      - SUPERSET_METADATA_DB_URI=postgresql://markinsight_user:localdev123@postgres:5432/superset_metadata
      - SUPERSET_JWT_SECRET_CURRENT=${SUPERSET_JWT_SECRET:-test-jwt-secret-for-dev}
      - SUPERSET_JWT_SECRET_PREVIOUS=${SUPERSET_JWT_SECRET_PREVIOUS:-}
      - REDIS_URL=redis://redis:6379/1
      - TALISMAN_ENABLED=false
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 5

  # =============================================================================
  # Backend API (FastAPI)
  # =============================================================================
  backend:
    build:
      context: .
      dockerfile: docker/backend.Dockerfile
    container_name: markinsight-api
    ports:
      - "8000:8000"
    environment:
      - ENV=development
      - PORT=8000
      - DATABASE_URL=postgresql://markinsight_user:localdev123@postgres:5432/markinsight
      - REDIS_URL=redis://redis:6379
      # For local dev, use test/mock values
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY:-test-clerk-secret-key}
      - CLERK_PUBLISHABLE_KEY=${CLERK_PUBLISHABLE_KEY:-test-clerk-publishable-key}
      - SHOPIFY_API_KEY=${SHOPIFY_API_KEY:-test-shopify-key}
      - SHOPIFY_API_SECRET=${SHOPIFY_API_SECRET:-test-webhook-secret-for-hmac}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-test-openrouter-key}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-dGVzdGVuY3J5cHRpb25rZXkxMjM0NTY3ODkwMTI=}
      - AIRBYTE_WORKSPACE_ID=${AIRBYTE_WORKSPACE_ID:-test-workspace}
      - AIRBYTE_API_TOKEN=${AIRBYTE_API_TOKEN:-test-token}
      # Enable test mode
      - SHOPIFY_BILLING_TEST_MODE=true
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend:/app/backend:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =============================================================================
  # Frontend (React/Vite) - Development Server
  # =============================================================================
  frontend:
    image: node:20-alpine
    container_name: markinsight-frontend
    working_dir: /app
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://localhost:8000
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 3000"
    depends_on:
      - backend

volumes:
  postgres_data:
  redis_data:
  frontend_node_modules:
